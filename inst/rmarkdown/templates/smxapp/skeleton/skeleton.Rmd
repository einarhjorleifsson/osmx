---
title: "Mælaborð íslenzkra ralla"
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r installations, eval = FALSE}
# INSTALLATIONS - YOU ONLY NEED TO DO THIS ONCE (ONCE IN A WHILE) --------------
remotes::install_local("R:/R/Pakkar/mardata", force = TRUE)
remotes::install_github("fishvice/xe", dependencies = FALSE)
remotes::install_github("tidyverse/dbplyr@v1.4.4", force = TRUE)
# further info, see: https://heima.hafro.is/~einarhj/xe/
```

```{r get_data, eval = FALSE}
# RUN THIS CHUNK line-by-line EACH TIME YOU HAVE GOTTEN NEW DATA IN HAFVOG
library(ROracle)
library(xe)
# 2023-09-26: NEW
#             Create the connection the database
#             Old setup: dbname = "xe"      (Klara)
#             New setup: dbname = "XEPDB1"  (Valur, Hlynur)
con <- connect_oracle(dbname = "XEPDB1")
# 2022-02-23:
#            import_hafvog2 is a temporary function, because veidarfaeri is NA
#            (some problem between different versions of hafvog - historical though
#             should not be a problem for new data in 2022)
# Specify the synaflokkur using the id and the gear using the gid. E.g.:
#         id 
# SMB     30
# SMH     35
res <- import_hafvog3(id = 30, con = con)
# just a quick fix
res$st <- 
  res$st %>% 
  dplyr::mutate(veidarfaeri = 73)
# Here specify whatever cruise(s) you want to include.
#  Make sure that these cruises are in your Hafvog, change accordingly
xe::munge_for_smxapp(res, cruise = c("TB1-2024", "A3-2024"))
```


```{r smxapp}
library(magrittr)
load("data2/smb_dashboard.rda")

pp <- 
  readr::read_rds("data2/pp.rds") %>% 
  dplyr::mutate(m.thyngd = round(thyngd/n, 2))
pp2 <- 
  pp %>% 
  dplyr::group_by(leidangur, stod, pred, nr, astand) %>% 
  dplyr::summarise(thyngd = sum(thyngd, na.rm = TRUE),
                   n = sum(n, na.rm = TRUE),
                   oslaegt = max(oslaegt, na.rm = TRUE),
                   .groups = "drop") %>% 
  dplyr::mutate(magafylli = round(thyngd / oslaegt * 100, 2))

Tegund <- sort(unique(by.tegund.lengd.ar$tegund))
# You may need next line if smb_dashboard.rda was generated in windose but
#  currently running linux - this is normally only needed when setting up
#  app on the MRI shiny-webserver
#fisktegundir$heiti <- iconv(fisktegundir$heiti, from = "ISO-8859-1", to = "UTF-8")
pp$prey <- iconv(pp$prey, from = "ISO-8859-1", to = "UTF-8")
x <- 
  fisktegundir %>% 
  dplyr::filter(tegund %in% Tegund) %>% 
  dplyr::mutate(val = paste(tegund, heiti)) %>% 
  dplyr::select(tegund, val)
my.species <- as.list(x$tegund)
names(my.species) <- iconv(x$val, from = "ISO-8859-1", to = "UTF-8")
x <- st %>% 
  dplyr::filter(ar == now.year) %>% 
  dplyr::select(leidangur) %>% 
  dplyr::distinct()
my.cruises <- as.list(x$leidangur)
names(my.cruises) <- x$leidangur



index.done.cruise <-
  tibble::tibble(index = index.done) %>% 
  dplyr::left_join(st %>% 
                     dplyr::filter(ar == now.year) %>% 
                     dplyr::select(leidangur, stod, index, togbyrjun))
last.20 <-
  st %>%  
  dplyr::filter(ar == now.year) %>% 
  dplyr::arrange(leidangur, desc(togbyrjun)) %>% 
  dplyr::group_by(leidangur) %>% 
  dplyr::slice(1:20) %>% 
  dplyr::mutate(id = dplyr::n():1) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(leidangur, id, index) %>% 
  dplyr::left_join(st %>% 
                     dplyr::select(index, ar, larett_opnun, lodrett_opnun,
                                   botnhiti, yfirbordshiti, vir_uti)) %>%
  tidyr::gather(variable, value, larett_opnun:vir_uti) %>% 
  dplyr::filter(!is.na(value))
st.dummy <-
  st %>%  
  dplyr::filter(index %in% index.done,
                ar == now.year) %>% 
  dplyr::select(leidangur, index) %>% 
  dplyr::left_join(st %>% 
                     dplyr::select(index, ar, larett_opnun, lodrett_opnun,
                                   botnhiti, yfirbordshiti, vir_uti)) %>%
  tidyr::gather(variable, value, larett_opnun:vir_uti) %>% 
  dplyr::filter(!is.na(value))

# skítamixið:
maeliatridi <- readr::read_rds("data2/maeliatridi.rds")
maeliatridi$heiti <- iconv(maeliatridi$heiti, 
                           from = "ISO-8859-1",
                           to = "UTF-8")
skr <- 
  readr::read_rds("data2/res.rds")$skraning %>% 
  dplyr::group_by(synis_id, maeliadgerd) %>% 
  dplyr::summarise(n = sum(fjoldi),
                   .groups = "drop")
MAELINGAR <- 
  st %>% 
  dplyr::filter(ar == now.year) %>% 
  dplyr::select(synis_id,
                leidangur,
                time = togbyrjun) %>% 
  dplyr::group_by(leidangur) %>% 
  dplyr::mutate(start.time = min(time),
                rel.time = as.numeric(time - start.time) / (60 * 60 * 24),
                max.time = max(rel.time)) %>% 
  dplyr::select(leidangur, rel.time, max.time, synis_id) %>% 
  dplyr::ungroup() %>% 
  dplyr::left_join(skr) %>% 
  dplyr::arrange(rel.time) %>% 
  tidyr::complete(rel.time, tidyr::nesting(leidangur, maeliadgerd), 
                  fill = list(n = 0)) %>% 
  dplyr::group_by(rel.time, leidangur) %>% 
  tidyr::fill(max.time) %>% 
  dplyr::filter(rel.time <= max.time) %>% 
  dplyr::arrange(rel.time) %>% 
  dplyr::left_join(maeliatridi) %>% 
  dplyr::group_by(leidangur, heiti) %>% 
  dplyr::mutate(n.cum = cumsum(n)) %>% 
  dplyr::ungroup()


res <- readr::read_rds("data2/res.rds")
tegund <- res$other.stuff$fisktegundir
tegund$heiti <- iconv(tegund$heiti, from = "ISO-8859-1", to = "UTF-8")

species.first.year <- 
  res$st %>% 
  dplyr::left_join(res$nu) %>% 
  dplyr::select(ar, reitur, tegund, fj_alls) %>% 
  dplyr::filter(!tegund %in% c(160,180,182,184,191,197,201,237,303,304,344,403,731:739,799,904)) %>% 
  dplyr::group_by(reitur, tegund) %>% 
  dplyr::summarise(first.year = min(ar)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(lon = geo::r2d(reitur)$lon,
                lat = geo::r2d(reitur)$lat)


by.rect <- 
  res$st %>% 
  dplyr::left_join(res$nu) %>% 
  dplyr::group_by(ar, reitur, tegund) %>% 
  dplyr::summarise(n = mean(fj_alls, na.rm = TRUE)) %>% 
  dplyr::filter(!is.na(tegund)) %>% 
  dplyr::group_by(ar, tegund) %>% 
  dplyr::mutate(n = ifelse(n > quantile(n, 0.975), quantile(n, 0.975), n)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(lon = geo::r2d(reitur)$lon,
                lat = geo::r2d(reitur)$lat)

scale_longitude_ices <- function(min = -44, max = 68.5, step = 1, ...) {
  breaks <- seq(min + 0.5, max - 0.5, step)
  labels <- geo::d2ir(60, breaks) %>% stringr::str_sub(3)
  return(ggplot2::scale_x_continuous(name = NULL, breaks = breaks, labels = labels, ...))
}
scale_latitude_ices <- function(min = 36, max = 84.5, step = 0.5, ...) {
  breaks <- seq(min + 0.25, max - 0.25, step)
  labels <- geo::d2ir(breaks, 0) %>% stringr::str_sub(1, 2)
  return(ggplot2::scale_y_continuous(name = NULL, breaks = breaks, labels = labels, ...))
}

# some addendums
tows.done <- 
  st.done.sf %>% dplyr::filter(year == now.year) %>% 
  sf::st_coordinates() %>% 
  tibble::as_tibble()

```

Sidebar {.sidebar data-width=175}
=====================================

```{r}
selectInput(inputId = "Species", label = "Tegund:",
            choices = my.species, selected = 1)


radioButtons(inputId = "Type", label = "Val:", 
             #choicesNames = list("Fjöldi", "Þyngd"),
             #choicesValues = list("Numbers", "Weight"),
             choices = list("Numbers", "Weight"),
             selected = list("Numbers"))

checkboxGroupInput(inputId = "Leidangur", label = "Leidangur:",
                   choices = my.cruises, selected = my.cruises)
```


Síðast uppfært: 

`r as.character(timi)`

ATH: Val á leiðangri ekki virkt í öllum gluggum.

Dót til prufu - um kóðann sem er á bak við má fræðast um nánar [hér](https://heima.hafro.is/~einarhj/older/gagnakvorn).

Forsíða
=====================================  

Column 
-------------------------------------

### Eftir lengd


```{r}
renderPlot({
  if(input$Type == "Numbers") 
  {
    ggplot2::ggplot() +
      ggplot2::theme_grey(base_size = 16) +
      ggplot2::geom_ribbon(data = by.tegund.lengd.ar.m %>% 
                             dplyr::filter(tegund == as.numeric(input$Species)),
                           ggplot2::aes(lengd, ymax = n.std, ymin = 0), fill = "grey") +
      ggplot2::geom_line(data = by.tegund.lengd.ar  %>% 
                           dplyr::filter(tegund == as.numeric(input$Species),
                                         ar >= 2010),
                         ggplot2::aes(lengd, n.std)) +
      ggplot2::facet_wrap(. ~ ar, dir = "v", ncol = 3) +
      ggplot2::labs(x = NULL, y = "Fjöldi í hverju lengdarbili") +
      ggplot2::scale_x_continuous(breaks = seq(10, 200, by = 20))
  } else {
    ggplot2::ggplot() +
      ggplot2::theme_grey(base_size = 16) +
      ggplot2::geom_ribbon(data = by.tegund.lengd.ar.m %>% 
                             dplyr::filter(tegund == as.numeric(input$Species)),
                           ggplot2::aes(lengd, ymax = b.std, ymin = 0), fill = "grey") +
      ggplot2::geom_line(data = by.tegund.lengd.ar  %>% 
                           dplyr::filter(tegund == as.numeric(input$Species),
                                         ar >= 2010),
                         ggplot2::aes(lengd, b.std)) +
      ggplot2::facet_wrap(. ~ ar, dir = "v", ncol = 3) +
      ggplot2::labs(x = NULL, y = "Þyngd [kg] í hverju lengdarbili") +
      ggplot2::scale_x_continuous(breaks = seq(10, 200, by = 20))
  } 
  
})

```


Column 
-------------------------------------

### Meðalafli - hártogun með staðalvikmörkum


```{r}
renderPlot({
  if(input$Type == "Numbers") 
  {
    by.station.boot %>% 
      dplyr::filter(tegund == as.numeric(input$Species),
                    variable == "n") %>% 
      ggplot2::ggplot(ggplot2::aes(ar, n.std)) +
      ggplot2::theme_grey(base_size = 16) +
      ggplot2::geom_pointrange(ggplot2::aes(ar, mean, ymin = lower.ci, ymax = upper.ci)) +
      ggplot2::scale_x_continuous(breaks = seq(1985, 2025, by = 5)) +
      ggplot2::expand_limits(y = 0) +
      ggplot2::labs(x = NULL, y = NULL)
  } else {
    by.station.boot %>% 
      dplyr::filter(tegund == as.numeric(input$Species),
                    variable == "b") %>% 
      ggplot2::ggplot(ggplot2::aes(ar, b.std)) +
      ggplot2::theme_grey(base_size = 16) +
      ggplot2::geom_pointrange(ggplot2::aes(ar, mean, ymin = lower.ci, ymax = upper.ci)) +
      ggplot2::scale_x_continuous(breaks = seq(1985, 2025, by = 5)) +
      ggplot2::expand_limits(y = 0) +
      ggplot2::labs(x = NULL, y = NULL)
  }
})

```

### Afli í staðaltogi árið `r now.year`

```{r}
leaflet::renderLeaflet({
  
  x0 <- 
    by.station %>% 
    dplyr::filter(ar == now.year) %>% 
    dplyr::select(lon, lat) %>% 
    dplyr::distinct()
  if(input$Type == "Numbers") {
    x <- 
      by.station %>% 
      dplyr::filter(ar == now.year,
                    tegund == as.numeric(input$Species),
                    n.std > 0) %>% 
      dplyr::select(lon, lat, n.std) %>% 
      dplyr::arrange(-n.std) |> 
      dplyr::mutate(n.std = floor(n.std))
    skali <- sqrt(max(x$n.std))
    leaflet::leaflet(x) %>% 
      leaflet::addTiles() %>% 
      leaflet::addCircles(data = x0, weight = 0.5, color = "white") %>% 
      leaflet::addCircles(weight = 1,
                          label = ~paste(n.std, "stykki"),
                          radius = ~sqrt(n.std)/skali * 5e4,
                          color = "red")
  } else {
    x <- 
      by.station %>% 
      dplyr::filter(ar == now.year,
                    b.std > 0,
                    tegund == as.numeric(input$Species)) %>% 
      dplyr::select(lon, lat, b.std) %>% 
      dplyr::arrange(-b.std) |> 
      dplyr::mutate(b.std = floor(b.std))
    skali <- sqrt(max(x$b.std))
    leaflet::leaflet(x) %>% 
      leaflet::addTiles() %>%
      leaflet::addCircles(data = x0, weight = 0.5, color = "white") %>% 
      leaflet::addCircles(weight = 1,
                          label = ~paste(round(b.std), "kg"),
                          radius = ~sqrt(b.std)/skali * 5e4,
                          color = "red")
  }
})

```

Dreifing
=====================================

Column {.tabset}
-------------------------------------

### Afli í staðaltogi

```{r}
renderPlot({
  if(input$Type == "Numbers") {
    by.station %>% 
      dplyr::filter(ar %in% c(1985, 1990, 1995, 2000, seq(2005, 2015, by = 2), now.year-1, now.year),
                    tegund == as.numeric(input$Species)) %>% 
      ggplot2::ggplot() +
      ggplot2::theme_grey(base_size = 16) +
      ggplot2::geom_path(data = geo::island, ggplot2::aes(lon, lat)) +
      ggplot2::geom_point(ggplot2::aes(lon, lat, size = n.std),
                          alpha = 0.25, colour = "red") +
      ggplot2::scale_size_area(max_size = 30) +
      ggplot2::coord_quickmap(xlim = range(by.station$lon, na.rm = TRUE),
                              ylim = range(by.station$lat, na.rm = TRUE)) +
      #ggplot2::theme(legend.position = c(0.5, 0.6)) +
      ggplot2::labs(x = NULL, y = NULL, size = "Stykki") +
      ggplot2::facet_wrap(~ ar, nrow = 3)
  } else {
    by.station %>% 
      dplyr::filter(ar %in% c(1985, 1990, 1995, 2000, seq(2005, 2015, by = 2), now.year - 1, now.year),
                    tegund == as.numeric(input$Species)) %>% 
      ggplot2::ggplot() +
      ggplot2::theme_grey(base_size = 16) +
      ggplot2::geom_path(data = geo::island, ggplot2::aes(lon, lat)) +
      ggplot2::geom_point(ggplot2::aes(lon, lat, size = b.std),
                          alpha = 0.25, colour = "red") +
      ggplot2::scale_size_area(max_size = 30) +
      ggplot2::coord_quickmap(xlim = range(by.station$lon, na.rm = TRUE),
                              ylim = range(by.station$lat, na.rm = TRUE)) +
      #ggplot2::theme(legend.position = c(0.5, 0.6)) +
      ggplot2::labs(x = NULL, y = NULL, size = "kg") +
      ggplot2::facet_wrap(~ ar, nrow = 3)
  }
})

```

### Tegund - fjöldi í reit

```{r}

renderPlot({
  n.glyph <- 
    by.rect %>% 
    dplyr::filter(tegund == input$Species) %>% 
    GGally::glyphs(x_major = "lon", 
                   y_major = "lat",
                   x_minor = "ar", 
                   y_minor = "n", 
                   width = 1, 
                   height = 0.5)
  
  n.glyph %>% 
    dplyr::mutate(years = ifelse(ar < now.year, "history", "current"),
                  pos = ifelse(n != 0, TRUE, FALSE),
                  base = lat - 0.25,
                  gy = ifelse(n == 0, gy + 0.005, gy)) %>% 
    ggplot2::ggplot() +
    ggplot2::theme_bw() +
    ggplot2::geom_linerange(ggplot2::aes(x = gx, ymin = base, ymax = gy,
                                         colour = years)) +
    #ggplot2::geom_(data = st.done.sp %>% sf::st_as_sf() %>% dplyr::filter(ar == 2021)) +
    ggplot2::geom_path(data = geo::island, ggplot2::aes(lon, lat)) +
    ggplot2::coord_quickmap() +
    scale_longitude_ices() +
    scale_latitude_ices() +
    ggplot2::scale_colour_manual(values = c("history" = "#377EB8", "current" = "#E41A1C")) +
    ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                   panel.grid.minor = ggplot2::element_line(size = 1),
                   axis.ticks = ggplot2::element_blank(),
                   legend.position = "none")
})
```



