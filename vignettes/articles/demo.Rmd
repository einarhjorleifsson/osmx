---
title: "demo"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Loading

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(mardata)
library(ovog)
library(osmx)
```

## Reading data from dumped zip-files

One can read in the data currently being collected using the `hv_import_cruise` that resides in the {ovog}-package:

```{r}
cruises <- c("~/R/Pakkar2/osmx/data-raw/SMH/TB2-2024.zip", "~/R/Pakkar2/osmx/data-raw/SMH/TTH1-2024.zip")
measurement <- 
  ovog::hv_import_cruise(cruises) |> 
  ovog::hv_create_tables()
```

The object returned is a list containing the following tables:

```{r}
names(measurement)
```

### Explorations - A sidestep

There should be nothing stopping you from doing analysis of the this data, e.g. one can easily get an overview of the reported station location via:

```{r}
measurement$stodvar |> 
  ggplot() +
  theme_bw() +
  geom_segment(aes(x = -kastad_v_lengd, y = kastad_n_breidd,
                   xend = -hift_v_lengd, yend = hift_n_breidd,
                   colour = factor(fishing_gear_no)),
               linewidth = 1) +
  coord_quickmap()
```

Or just the length distributions of some selected species via:

```{r}
measurement$lengdir |> 
  filter(tegund %in% 1:3) |> 
  group_by(tegund, lengd) |> 
  reframe(n = sum(n)) |> 
  ggplot(aes(lengd, n)) +
  geom_col() +
  facet_wrap(~ tegund, scales = "free_y")
```

## Merging and data transformation

Normally we would ...

```{r}
cruises <- c("~/R/Pakkar2/osmx/data-raw/SMH/TB2-2024.zip", "~/R/Pakkar2/osmx/data-raw/SMH/TTH1-2024.zip")
stillingar <- c("~/R/Pakkar2/osmx/data-raw/SMH/stillingar_SMH_rall_(haust).zip")
stodtoflur <- c("~/R/Pakkar2/osmx/data-raw/SMH/stodtoflur.zip")
res <- sm_munge(cruises, stillingar, stodtoflur)
```

## Exploration outside the smx-app

### Sum of catch by lengths

```{r}
res$by.length |> 
  dplyr::filter(tegund == 2,
                ar >= 2010) |> 
  dplyr::filter(var == "n") |> 
  sm_plot_lengths()
```

### Mean catch per station

```{r}
res$boot |> 
  dplyr::filter(tegund == 1,
                var == "b") |> 
  sm_plot_boot()
```

### Catch by station

```{r}
res$by.station |> 
  dplyr::filter(tegund == 1,
                var == "b",
                ar %in% c(seq(2000, 2015, by = 5),
                          2017:2024)) |>
  sm_plot_bubble()
```

### Catch by square

... pending

### Probability of capture

... pending

### Length-ungutted

```{r}
res |> sm_plot_length_ungutted()
```

### Lengths-gutted

```{r}
res |> sm_plot_length_gutted()
```

### Lengths vs gutted / ungutted

```{r}
res |> sm_plot_weights()
```

### Lengths vs liver / ungutted

```{r}
res |> sm_plot_liver()
```

### Lengths vs gonads / ungutted

```{r}
res |> sm_plot_gonads()
```

### QC table: Length limits

... pending

### QC table: Measurement limits

```{r}
res$kv.this.year |> 
  dplyr::filter(leidangur %in% "TB2-2024") |> 
  sm_table_kvarnir()
```


### Prey table

```{r}
res$pp |> 
  dplyr::filter(leidangur %in% "TB2-2024",
                astand %in% 1) |> 
  sm_table_prey()
```

### Prey table - summarise by predator

```{r}
res$pp |> 
  dplyr::filter(leidangur %in% "TB2-2024") |> 
  dplyr::group_by(leidangur, stod, fiskur, fnr, flengd, oslaegt, astand ) |> 
  dplyr::reframe(n = sum(n, na.rm = TRUE),
                 wt = sum(heildarthyngd, na.rm = TRUE)) |>
  dplyr::mutate(magafylli = round(wt / oslaegt, 3)) |> 
  sm_table_prey()
```

### Pred-prey figures

```{r}

```




### Surf and turf

... pending

### Gear metrics - last 20 stations

```{r}
res$timetrend.20 |> 
  filter(leidangur %in% "TB2-2024",
         var %in% c("larett_opnun", "lodrett_opnun", "vir_uti")) |> 
  sm_plot_last20()
```

### Temperatures - last 20 stations

```{r}
res$timetrend.20 |> 
  filter(leidangur %in% "TB2-2024",
         var %in% c("botnhiti", "yfirbordshiti")) |> 
  sm_plot_last20()
```

### Gear metrics - time trends

```{r}
res$timetrend |> 
  filter(leidangur %in% "TB2-2024",
         var %in% c("larett_opnun", "lodrett_opnun", "vir_uti")) |> 
  sm_plot_violin()
```


### Temperature - time trends

```{r}
res$timetrend |> 
  filter(leidangur %in% "TB2-2024",
         var %in% c("botnhiti", "yfirbordshiti")) |> 
  sm_plot_violin()
```

